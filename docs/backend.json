{
  "entities": {
    "Poll": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Poll",
      "type": "object",
      "description": "Represents a poll with questions, options, and status.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the poll."
        },
        "question": {
          "type": "string",
          "description": "The question presented in the poll."
        },
        "options": {
          "type": "array",
          "description": "Available options for the poll question.",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "text": { "type": "string" }
            },
            "required": ["id", "text"]
          }
        },
        "status": {
          "type": "string",
          "description": "The status of the poll (e.g., open, closed).",
          "enum": ["draft", "active", "closed"]
        },
        "pollType": {
          "type": "string",
          "description": "The type of poll (simple or multiple choice).",
          "enum": ["simple", "multiple"]
        },
        "maxSelections": {
          "type": "number",
          "description": "Maximum number of options a voter can select in a multiple choice poll."
        },
        "groupId": {
            "type": "string",
            "description": "The ID of the voter group this poll is for."
        },
        "adminId": {
          "type": "string",
          "description": "Reference to the Admin who created the poll. (Relationship: Admin 1:N Poll)"
        },
        "createdAt": {
            "type": "string",
            "format": "date-time",
            "description": "Timestamp of when the poll was created."
        }
      },
      "required": [
        "id",
        "question",
        "options",
        "status",
        "pollType",
        "groupId",
        "adminId",
        "createdAt"
      ]
    },
    "Voter": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Voter",
      "type": "object",
      "description": "Represents a registered voter and their voting status for a specific poll.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the voter record."
        },
        "pollId": {
          "type": "string",
          "description": "Reference to the Poll this voter is associated with. (Relationship: Poll 1:N Voter)"
        },
        "voterId": {
          "type": "string",
          "description": "The business-logic unique identifier for the voter."
        },
        "hasVoted": {
          "type": "boolean",
          "description": "Indicates whether the voter has already voted in the poll."
        }
      },
      "required": [
        "id",
        "pollId",
        "voterId",
        "hasVoted"
      ]
    },
    "Vote": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Vote",
      "type": "object",
      "description": "Represents an anonymous vote cast in a poll.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the vote."
        },
        "pollId": {
          "type": "string",
          "description": "Reference to the Poll this vote belongs to. (Relationship: Poll 1:N Vote)"
        },
        "selectedOptions": {
          "type": "array",
          "description": "The option(s) selected by the voter.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "pollId",
        "selectedOptions"
      ]
    },
    "Admin": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Admin",
      "type": "object",
      "description": "Represents an administrator user.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the administrator."
        },
        "email": {
          "type": "string",
          "description": "Email address of the administrator.",
          "format": "email"
        }
      },
      "required": [
        "id",
        "email"
      ]
    },
    "VoterGroup": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Voter Group",
      "type": "object",
      "description": "Represents a reusable group of voters created by an admin.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the voter group." },
        "name": { "type": "string", "description": "The name of the voter group." },
        "adminId": { "type": "string", "description": "The ID of the admin who owns this group." },
        "voters": {
          "type": "array",
          "description": "A list of voters in this group.",
          "items": {
            "type": "object",
            "properties": {
              "id": { "type": "string", "description": "The unique identifier for the voter." },
              "nombre": { "type": "string", "description": "The first name of the voter." },
              "apellido": { "type": "string", "description": "The last name of the voter." }
            },
            "required": ["id", "nombre", "apellido"]
          }
        },
        "createdAt": { "type": "string", "format": "date-time", "description": "Timestamp of when the group was created." }
      },
      "required": ["id", "name", "adminId", "voters", "createdAt"]
    },
    "PollLookup": {
      "title": "Poll Lookup",
      "type": "object",
      "description": "A lookup document to find the adminId for a given pollId.",
      "properties": {
        "adminId": {
          "type": "string",
          "description": "The ID of the admin who created the poll."
        }
      },
      "required": ["adminId"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/admins/{adminId}",
        "definition": {
          "entityName": "Admin",
          "schema": {
            "$ref": "#/backend/entities/Admin"
          },
          "description": "Collection to store administrator profiles.",
          "params": [
            {
              "name": "adminId",
              "description": "Unique identifier for the administrator."
            }
          ]
        }
      },
      {
        "path": "/admins/{adminId}/polls/{pollId}",
        "definition": {
          "entityName": "Poll",
          "schema": {
            "$ref": "#/backend/entities/Poll"
          },
          "description": "Subcollection to store polls created by each admin. Includes denormalized 'adminId' for authorization independence.",
          "params": [
            {
              "name": "adminId",
              "description": "Unique identifier for the administrator."
            },
            {
              "name": "pollId",
              "description": "Unique identifier for the poll."
            }
          ]
        }
      },
      {
        "path": "/admins/{adminId}/polls/{pollId}/voters/{voterId}",
        "definition": {
          "entityName": "Voter",
          "schema": {
            "$ref": "#/backend/entities/Voter"
          },
          "description": "Subcollection to store voters registered for a specific poll. Includes denormalized 'pollId' for authorization independence.",
          "params": [
            {
              "name": "adminId",
              "description": "Unique identifier for the administrator."
            },
            {
              "name": "pollId",
              "description": "Unique identifier for the poll."
            },
            {
              "name": "voterId",
              "description": "Unique identifier for the voter."
            }
          ]
        }
      },
      {
        "path": "/admins/{adminId}/polls/{pollId}/votes/{voteId}",
        "definition": {
          "entityName": "Vote",
          "schema": {
            "$ref": "#/backend/entities/Vote"
          },
          "description": "Subcollection to store anonymous votes cast in a specific poll. Includes denormalized 'pollId' for authorization independence.",
          "params": [
            {
              "name": "adminId",
              "description": "Unique identifier for the administrator."
            },
            {
              "name": "pollId",
              "description": "Unique identifier for the poll."
            },
            {
              "name": "voteId",
              "description": "Unique identifier for the vote."
            }
          ]
        }
      },
      {
        "path": "/admins/{adminId}/groups/{groupId}",
        "definition": {
          "entityName": "VoterGroup",
          "schema": {
            "$ref": "#/backend/entities/VoterGroup"
          },
          "description": "Subcollection to store reusable voter groups created by each admin.",
          "params": [
            {
              "name": "adminId",
              "description": "Unique identifier for the administrator."
            },
            {
              "name": "groupId",
              "description": "Unique identifier for the voter group."
            }
          ]
        }
      },
      {
        "path": "/poll-lookup/{pollId}",
        "definition": {
          "entityName": "PollLookup",
          "schema": {
            "$ref": "#/backend/entities/PollLookup"
          },
          "description": "A public lookup table to find the admin owner of a poll.",
          "params": [
            {
              "name": "pollId",
              "description": "Unique identifier for the poll."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to ensure authorization independence, clarity, and scalability, adhering to the principles of DBAC (Database-Based Access Control) and QAPs (Rules are not Filters).  It leverages denormalization to avoid `get()` calls in security rules, enabling atomic operations and simplifying debugging.\n\n**Authorization Independence:**\n\n*   `Polls`: The `adminId` field within each poll document directly associates the poll with its creator, eliminating the need to fetch admin data during authorization.\n*   `Voters`: The `pollId` field within each voter document links the voter to a specific poll. This design prevents the need to query across different polls for voting status and maintains authorization independence.\n*   `VoterGroups`: Are stored under the admin who created them, ensuring strict ownership and simple security rules.\n\n**Structural Segregation:**\n\n*   The database separates polls, voters, votes, and groups into distinct collections. This segregation allows for specific and straightforward security rules for each entity.\n\n**Access Modeling:**\n\n*   **Path-Based Ownership:** Polls and Groups are accessed via `/admins/{adminId}/...`, making ownership clear and security rules simple.\n*   **One-to-Many Relationship:** The structure reflects the one-to-many relationships between Admins and Polls, Admins and VoterGroups, Polls and Voters, and Polls and Votes through hierarchical paths.\n\n**QAPs Support:**\n\n*   The structure enables secure `list` operations because access control is enforced at the collection level (e.g., only the admin can list polls/groups under their ID).\n\n**Invariants:**\n\n*   The structure supports the integrity of ownership, timestamps, and denormalized data. For example, `adminId` maintains clear ownership."
  }
}
